{% load static %}
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabriot KDS</title>
    <!-- Add your CSS, Bootstrap, and other head elements here -->
    <!-- Include Masonry.js from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
</head>
<style>
.navbar-brand {
        font-size: 2rem;
        font-weight: bold;
    }

    .navbar {
        height: 56px;
        padding: 0;
    }
    .container, .p-5.my-3 {
    padding: 0;
    margin: 0;
    }
    body {
    padding-top: 0;
    padding-left: 0;
    padding-right: 0;
    }
/* Navbar Styling */
.navbar-brand {
    font-size: 2rem;
    font-weight: bold;
}

.navbar {
    height: 56px;
    padding: 0;
}
#orders-grid {
    column-count: 6; /* 6-column grid for larger screens */
    column-gap: 1rem; /* Adjust spacing between columns */
}

.masonry-item {
    display: inline-block;
    margin-bottom: 1rem;
<!--    width: 100%;-->
}

@media (max-width: 1200px) {
    #orders-grid {
        column-count: 4; /* Adjust for medium screens */
    }
}

@media (max-width: 768px) {
    #orders-grid {
        column-count: 2; /* Adjust for small screens */
    }
}


.container, .p-5.my-3 {
    padding: 0;
    margin: 0;
}

body {
    padding-top: 0;
    padding-left: 0;
    padding-right: 0;
}

/* Masonry Grid: Ensure masonry layout behaves responsively */
.masonry-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 1rem;
}

/* Ensure items stack naturally in a masonry style */
.masonry-item {
    break-inside: avoid;
}

@media (max-width: 992px) {
    .masonry-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 768px) {
    .masonry-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 576px) {
    .masonry-grid {
        grid-template-columns: 1fr;
    }
}
.card {
    break-inside: avoid;
}
.container {
    max-width: 100%; /* Ensure the container spans full width */
}
/* Card Styling */
./* Custom Badge Styles */
.custom-badge {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.3rem 0.6rem;
    border-radius: 0.5rem;
}

/* Card Header and Body */
<!--.card-header {-->
<!--    background-color: #f8f9fa;-->
<!--    border-bottom: none;-->
<!--}-->

<!--.card-header h6 {-->
<!--    font-size: 0.85rem;-->
<!--}-->

<!--.card-body {-->
<!--    font-size: 0.8rem;-->
<!--}-->

<!--.card-body .fw-bold {-->
<!--    font-size: 0.9rem;-->
<!--}-->
body {
    background-color: #f0f4f8; /* Light gray background */
}

.card {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Softer shadow */
    border: none;
    margin-bottom: 16px;
}

.card-header,
.card-body {
    padding: 8px 12px; /* Reduced padding */
}

.badge.custom-badge {
    font-size: 0.75rem; /* Smaller badge text */
    padding: 0.25em 0.5em;
}


/* Typography for Labels and Count */
.text-muted {
    color: #6c757d;
}

.fw-bold {
    font-weight: 700;
}


/* Badge Colors */
.bg-success {
    background-color: #28a745 !important;
}
.bg-danger {
    background-color: #dc3545 !important;
}
.bg-warning {
    background-color: #ffc107 !important;
}

/* Count Section Styling */
.text-center mt-2 p {
    font-size: 1rem;
    font-weight: bold;
}

/* Responsive Grid - Media Queries */
@media (max-width: 576px) {
    .card {
        margin-bottom: 15px;  /* Add spacing between cards on mobile */
    }
}

@media (max-width: 768px) {
    .card-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .card-header .text-end {
        text-align: left;
    }
}

@media (min-width: 992px) {
    .card-header {
        flex-direction: row;
        align-items: center;
    }

    .card-header .text-end {
        text-align: right;
    }
}
.text-capitalize {
    text-transform: capitalize;
}
.custom-small {
    font-size: 0.50rem; /* Further reduce the font size if needed */
}
.custom-medium {
    font-size: 0.75rem; /* Further reduce the font size if needed */
}



</style>
<body>
    <!-- Navbar and other header content -->
<!--<header>-->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top p-5">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <!-- Left Section: Logo and Title -->
            <div class="d-flex align-items-center">
                <img src="{% static 'image/cabriot_Orderlogo.png' %}" alt="Logo"  height="100" class="me-3">
                <h2 class="navbar-brand mb-0 fs-1 text-white">Orders</h2>
            </div>
            <!-- Right Section: Date and Last Updated Time -->
            <div class="d-flex align-items-center ms-auto">
              <div class="text-end text-white">
                <p class="mb-0"><strong>{{ current_date|date:"l, F j, Y" }}</strong></p>
                <p id="heading" class="mb-0 fs-5"></p>
                <small class="mb-0 fs-8">Last Updated 30 minutes ago</small>
              </div>
            </div>
        </div>
    </nav>
<!--</header>-->
<div class="container" id="masonry-container">
    <div class="masonry-grid" id="orders-grid">
        {% for order in orders %}
            <div class="masonry-item">
                <div class="card h-100 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center p-2">
                        <h6 class="mb-0 fw-bold text-capitalize">{{ order.client__name|default:"Unnamed Client"|upper }}</h6>
                        <span class="badge custom-badge
                            {% if order.order_status == 'Cooking' %} bg-success
                            {% elif order.order_status == 'Dispatched' %} bg-primary
                            {% elif order.order_status == 'Ready' %} bg-info
                            {% else %} bg-warning
                            {% endif %}">
                            {{ order.order_status }}
                        </span>
                    </div>
                    <div class="col px-2 py-1 d-flex justify-content-between align-items-center border border-light">
                        <div class="text-start custom-medium">{{ order.meal_type }}</div>
                        <div class="text-end custom-small">Order #: {{ order.order_number }}</div>
                    </div>
                    <div class="card-body p-2">
                        {% for item in items_json %}
                            {% if item.order_id == order.id %}
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted small">{{ item.item__item_name }}</span>
                                    <span class="text-muted small">{{ item.quantity|default:"0" }} {{ item.quantity_type|default:"" }}</span>
                                </div>
                            {% endif %}
                        {% endfor %}
                        <div class="text-center fw-bold py-1">
                            COUNT: <span>{{ order.total_pax_quantity|default:" " }}</span>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>











<div id="orders" hidden data-orders="{{ orders|json_script:'ordersData' }}"></div>
<!--<div id="items-data" data-items='{{ items_json|escapejs }}'></div>-->
<div id="items-data" hidden data-items="{{ items_json|json_script:'itemsData' }}'"></div>


<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <!-- Main Content Section -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer Section (optional) -->
    <footer>
        <!-- Add footer content here -->
    </footer>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const ordersDataElement = document.getElementById('orders');
    const itemsDataElement = document.getElementById('items-data');

    if (!ordersDataElement || !itemsDataElement) {
        console.error('Element with specified ID not found.');
        return;
    }

    const cleanData = (rawData) => rawData.replace(/["'>]+$/, '').trim();
    const orders_checks = cleanData(ordersDataElement.textContent.trim());
    const items_checks = cleanData(itemsDataElement.textContent.trim());

    try {
        const orders_Data = JSON.parse(orders_checks);
        const items_Data = JSON.parse(items_checks);
        localStorage.setItem('orders', JSON.stringify(orders_Data));
        localStorage.setItem('items', JSON.stringify(items_Data));
    } catch (error) {
        console.error('JSON parsing error:', error);
    }

    async function loadOrdersAndItems() {
        const url = "{% url 'orders:order' %}";
        const storedOrders = JSON.parse(localStorage.getItem('orders')) || [];
        const storedItems = JSON.parse(localStorage.getItem('items')) || [];

        try {
            const response = await fetch(url, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            if (!response.ok) {
                console.error('Error fetching data:', response.status, response.statusText);
                return;
            }

            const data = await response.json();
            const orders = data.orders;
            const items = data.items_json;

            if (JSON.stringify(orders) === JSON.stringify(storedOrders) &&
                JSON.stringify(items) === JSON.stringify(storedItems)) {
                renderOrdersAndItems(storedOrders, storedItems);
            } else {
                renderOrdersAndItems(orders, items);
                localStorage.setItem('orders', JSON.stringify(orders));
                localStorage.setItem('items', JSON.stringify(items));
            }

            initializeMasonry();
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    function initializeMasonry() {
        const masonryGrid = document.querySelector('#orders-grid');
        if (masonryGrid) {
            const masonryInstance = new Masonry(masonryGrid, {
                itemSelector: '.masonry-item',
                columnWidth: '.masonry-item',
                percentPosition: true,
                gutter: 20,
            });

            masonryInstance.on('layoutComplete', function () {
                console.log('Masonry layout completed.');
            });

            masonryInstance.layout();
        }
    }

    function renderOrdersAndItems(orders, items) {
    const masonryContainer = document.getElementById('masonry-container');
    let masonryHTML = ''; // Initialize an empty string for accumulating HTML

    if (Array.isArray(orders)) {
        orders.forEach(order => {
            const badgeClass = getBadgeClass(order.order_status);
            const clientName = order.client__name || 'Unnamed Client';
            const upperClientName = clientName.toUpperCase();

            // Header Template
            const headerTemplate = `
                <div class="card-header d-flex justify-content-between align-items-center p-2">
                    <div class="text-start">
                        <h6 class="mb-0 fw-bold text-capitalize">${upperClientName}</h6>
                    </div>
                    <div class="text-end">
                        <span class="badge custom-badge ${badgeClass}">${order.order_status}</span>
                    </div>
                </div>
            `;

            // Body Template
            const bodyTemplate = `
                <div class="card-body p-2">
                    <!-- Meal Type and Order Number -->
                    <div class="col px-2 py-1 d-flex justify-content-between align-items-center border border-light">
                        <div class="text-start custom-medium">${order.meal_type}</div>
                        <div class="text-end custom-small">Order #: ${order.order_number}</div>
                    </div>

                    <!-- Items Rows -->
                    ${generateItemsRows(order, items)}

                    <!-- Total Count -->
                    <div class="text-center fw-bold py-1">
                        COUNT: <span>${order.total_pax_quantity || ' '}</span>
                    </div>
                </div>
            `;

            // Function to generate item rows dynamically
            function generateItemsRows(order, items) {
                let itemRowsHTML = '';
                items.forEach(item => {
                    if (item.order_id === order.id) {
                        itemRowsHTML += `
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted small">${item.item__item_name}</span>
                                <span class="text-muted small">${item.quantity || "0"} ${item.quantity_type || ""}</span>
                            </div>
                        `;
                    }
                });
                return itemRowsHTML;
            }

            // Complete Card Template
            const cardTemplate = `
                <div class="masonry-item">
                    <div class="card shadow-sm border-light rounded-3">
                        ${headerTemplate}
                        ${bodyTemplate}
                    </div>
                </div>
            `;

            masonryHTML += cardTemplate;
        });

        masonryContainer.innerHTML = masonryHTML;

        // Initialize Masonry grid after the content has been added
        requestAnimationFrame(() => {
            initializeMasonry();
        });
    }
}



    function getBadgeClass(status) {
        switch (status) {
            case 'Cooking': return 'bg-success';
            case 'Dispatched': return 'bg-primary';
            case 'Ready': return 'bg-info';
            default: return 'bg-warning';
        }
    }

    function generateItemsRows(order, items) {
        const orderItems = items.filter(item => item.order_id === order.id);
        if (orderItems.length === 0) return '<div class="text-muted small text-center">No items for this order</div>';
        return orderItems.map(item => `
            <div class="d-flex justify-content-between mb-1">
                <span class="text-muted small">${item.item__item_name}</span>
                <span class="text-muted small">${item.quantity || '0'} ${item.quantity_type || ''}</span>
            </div>
        `).join('');
    }

    function updateTime() {
        const now = new Date();
        const formattedTime = `${String(now.getHours() % 12 || 12).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')} ${now.getHours() >= 12 ? 'PM' : 'AM'}`;
        document.getElementById('heading').textContent = formattedTime;
    }

    updateTime();
    loadOrdersAndItems();
    setInterval(updateTime, 1000);
    setInterval(loadOrdersAndItems, 10000);
});
</script>







</body>
</html>
